<!DOCTYPE html>
<html>
  <head>
    <title>Hunt Canvas</title>
    <link href = "http://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css" rel = "stylesheet" type = "text/css"/>
    <script src = "./jquery-3.3.1.min.js"></script>
    <script src = "./cytoscape.min.js"></script>
    <script src="https://cdn.rawgit.com/konvajs/konva/2.0.3/konva.min.js"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
   crossorigin="anonymous"></script>

    <script>
      var clues = new Array();
      var lastKnownClue;
      var layer = new Konva.Layer();
      var WIDTH = window.innerWidth * 0.795;
      var HEIGHT = window.innerHeight * 0.79;
      var centerX;
      var centerY;
      var stage;
      var TEXT_THRESHHOLD = 55;
      var LINE_THRESHHOLD = 8;

      $(document).ready(function(){
        $('#side-bar-menu').load("./sidebar.html");

        $('#dialog-form').dialog({
          autoOpen:false,
          position:{
            me:'center',
            at:'center',
            of: window
          },
          title:"clue-builder",
          modal:true,
          buttons:{
            "pin-to-canvas":function(){
              var title = $('#clue-title-field').val();
              var body = $('#clue-body-field').val();
              var keywords = $('#clue-keywords-field').val();
              if(title != '' && body != '' && keywords != ''){
                var clue = new Clue(title,body);
                clues.push(clue);
                addClue(clue);
                $(this).dialog("close");
              }
            },
            "cancel":function(){
              $(this).dialog("close");
            }
          }
        });

        $('#context-menu').menu();
        $('#control-buttons-container button').click(function(){
          $('#dialog-form').dialog("open");
        });
        /*var cy = cytoscape({
          container: $('#canvas'),
          elements:[
            {data:{id:'a'}},
            {data:{id:'b'}},
            {
              data: {
                id: 'ab',
                source: 'a',
                target: 'b'
              }
            }
          ],
          style:[{
            selector:'node',
            style:{
              shape: 'circle',
              'background-color':'white',
              'border-color': 'blue',
              'border-width':3,
              'width':50,
              'height':50,
              label: 'data(id)',
              'text-margin-y':'20%'
            }
          }],
          layout:{
            name: 'grid'
          }
        });

        cy.layout({name:'circle'}).run();*/

        stage = new Konva.Stage({
          container: "detail-canvas",
          width: WIDTH,
          height: HEIGHT
        });
        centerX = stage.getWidth()/2;
        centerY = stage.getHeight()/2;

      });

      function addClue(clue){
        //organize body text into lines if necessary
        var str = '';
        if(clue.body.length >= TEXT_THRESHHOLD){
          var numOfLines = Math.ceil(clue.body.length/20);
          if(numOfLines > LINE_THRESHHOLD){
            clue.body += '...';
            numOfLines = LINE_THRESHHOLD;
          }
          var startIndex = TEXT_THRESHHOLD * -1;
          var endIndex = 0;
          for(var i=0;i<numOfLines;i++){
            startIndex = startIndex + TEXT_THRESHHOLD;
            endIndex = endIndex + TEXT_THRESHHOLD;

            if(endIndex >= clue.body.length){
              endIndex = clue.body.length - 1;
            }
            str += clue.body.substr(startIndex,endIndex);
            if(i != numOfLines - 1){
              str += '\n';
            }
          }
        }else{
          str = clue.body;
        }
        //restrict title length
        if(clue.title.length > 18){
          clue.title = clue.title.substr(0,15) + '...';
        }

        var group = new Konva.Group({
            draggable: true,
            dragBoundFunc: function(pos){
              var xpos = pos.x;
              var ypos = pos.y;

              if(xpos < -508){
                xpos = -508;
              }else if(xpos > 308){
                xpos = 308;
              }

              if(ypos < -208){
                ypos = -208;
              }else if(ypos > 187){
                ypos = 187;
              }

              return {
                x: xpos,
                y: ypos
              }

            }
        });
        var header_rect = new Konva.Rect({
          x:centerX,
          y:centerY - 60,
          width:200,
          height:25,
          fill:'#365382'
        });
        var clue_title = new Konva.Text({
          x:centerX + 3,
          y:centerY - 55,
          text:clue.title,
          fill:"white",
          fontStyle:"bold"
        });
        var clue_body_container = new Konva.Line({
          points:[centerX+1,centerY - 35,centerX+1,centerY + 80,centerX+199,centerY + 80,centerX+199,centerY-35],
          stroke:'black',
          strokeWidth: 1
        });
        var body_text = new Konva.Text({
          x:centerX + 3,
          y:centerY - 28,
          text:str,
          fill:'black',
          fontStyle:"bold",
          fontSize:8
        });
        group.add(header_rect);
        group.add(clue_title);
        group.add(clue_body_container);
        group.add(body_text);
        group.on('dblclick',function(){

        });
        layer.add(group);
        stage.add(layer);
      }

      function Clue(title,body,number){
        this.title = title;
        this.body = body;
        this.number = number;
      }

      function textAreaCharacterCount(){
        var count = $('#clue-body-field').val().length;
        $('#clue-body-count').text(count + " character(s)");
      }
      function keywordCount(){
        var text = $('#clue-keywords-field').val();
        var count = text.split(',').length;
        if(count == 1 && text == ''){
          count = 0;
        }
        $('#clue-keyword-count').text(count + " word(s)");
      }
    </script>
    <style>
      .horizontal-container{
        display: inline-block;
      }
      #title{
        background-color: #724403;
        color: white;
        padding: 1%;
        width: 80vw;
        font-family: baby-love;
        border-style: solid;
        border-color: black;
        border-width: thin;
      }
      #page-content-container{
        position: absolute;
        margin-left: 2vw;
      }
      #detail-canvas{
        border-style: solid;
        width:80vw;
        height:80vh;
        margin-top:2%;
      }
      .box-content{
        border: dashed;
        width: 80vw;
        color: #bec4ce;
      }
      .view-control-button{
        color:white;
        background-color: #040930;
        border-radius:10px;
        font-family: digital-letters;
      }

      #control-buttons-container button{
        position: relative;
        float:right;
        border:none;
        color: white;
        background-color: green;
        font-size: 15px;
        margin-bottom: 1%;
        border-radius: 5px;
        font-family: digital-letters;
      }
      #side-section{
        border-style: dashed;
        width: 15vw;
        height:48vh;
        margin-top: 1%;
      }
      #side-section-title{
        font-weight: bold;
        font-family: digital-letters;
        font-size: 25px;
        color:#193666;
      }

      #dialog-form .clue-input-fields{
        position:relative;
        width:100%;
      }
      #dialog-form textarea{
        resize: none;
        text-align: left;
      }
      #dialog-form span{
        font-size: 10px;
      }


    </style>
  </head>
  <body>
    <div id = "side-bar-menu" class = "horizontal-container"></div>
    <div id = "page-content-container" class = "horizontal-container">
      <h1 id = "title">Welcome to the hunt canvas</h1>
      <button class = "view-control-button">Detail-View</button>
      <button class = "view-control-button">Graph-View</button>
      <span id = "control-buttons-container">
        <button class = "glyphicon">&#x2b;<span> ADD A CLUE</span></button>
      </span>
      <br/>
      <div id = "detail-canvas"></div>
      <h2 id = "hunt-history-title">History</h2>
      <div id = "hunt-history" class = "box-content">
        No History.
      </div>
      <div id = "dialog-form">
        <form>
          <br/>
          <input class = "clue-input-fields" id = "clue-title-field" name = "clue-title-field" type = "text" placeholder="title..or heading of your clue..."/>
          <span id = "clue-body-count">0 characters</span><br/>
          <textarea id = "clue-body-field" name = "clue-body-field" placeholder="compose your clue here..." cols = "30" rows = "8" oninput="textAreaCharacterCount()"></textarea>
          <span id = "keywords-label">Keyword(s): a comma seperated list of clue solutions</span>
          <textarea id = "clue-keywords-field" placeholder="keyword(s)..." cols = "30" rows = "3" oninput = "keywordCount()"></textarea>
          <span id = "clue-keyword-count">0 word(s)</span>
        </form>
      </div>
      <div id = "context-menu">
        <ul>
          <li>view</li>
          <li>edit</li>
          <li>delete</li>
        </ul>
      </div>
    </div>
    <div id = "side-section">
      <span id = "side-section-title">Active Hunt</span>
      <hr/>
      <div id = "side-section-content">no hunts are active.</div>
    </div>
  </body>
</html>
